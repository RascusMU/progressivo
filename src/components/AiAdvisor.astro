---
---

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">

<!-- AI ADVISOR BUTTON -->
<button id="jc-advisor-btn">
  <span class="jc-initials">
    <span class="j-letter">J</span><span class="c-letter">C</span>
  </span>
</button>

<!-- AI ADVISOR MODAL -->
<div id="progressivoAdvisorModal" class="hidden">
    <div>
        <button id="advisor-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div>
            <h2 id="advisor-title">Business Advisor</h2>
            <p id="advisor-subtitle">PopiÅ¡te svou situaci a doporuÄÃ­m vÃ¡m Å™eÅ¡enÃ­.</p>

            <div id="progressivoAdvisorHistory" style="margin-top: 20px; max-height: 400px; overflow-y: auto;"></div>

            <textarea id="progressivoAdvisorInput" placeholder="NapÅ™: Chci zaloÅ¾it firmu v PanamÄ›..."></textarea>

            <button id="advisor-ask-btn">
                <svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor" style="display:inline-block; vertical-align:middle; margin-right:4px;"><path d="M224 96a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm122.5 23.3c-1.3-8.8-12.7-8.8-14 0L326 160l-40.7 6.5c-8.8 1.4-8.8 12.8 0 14.2L326 187l6.5 40.7c1.4 8.8 12.8 8.8 14.2 0l6.5-40.7 40.7-6.5c8.8-1.4 8.8-12.8 0-14.2L353.5 160l-6.5-40.7zM448 96a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM83.8 281.3C68.9 266.3 44.7 266.3 29.8 281.3s-14.9 39.1 0 54.1l208 208c14.9 14.9 39.1 14.9 54.1 0s14.9-39.1 0-54.1l-208-208zm26.9-26.9L379.3 85.8c6-6 15.5-6.6 22.2-1.5l26.2 19.6c6.4 4.8 6.9 14 1.2 19.5L163.5 379.6c-4.3 4.1-11.2 4.2-15.6 .2l-36.8-33.1c-4.4-4-4.5-10.9-.4-15.4z"/></svg> Poradit mi
            </button>
        </div>
    </div>
</div>

<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BUTTON STYLES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  #jc-advisor-btn {
    position: fixed !important;
    bottom: 24px !important;
    right: 24px !important;
    z-index: 10000 !important;

    width: 56px !important;
    height: 56px !important;
    border-radius: 9999px !important;

    display: flex !important;
    align-items: center !important;
    justify-content: center !important;

    background: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;

    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;

    cursor: pointer !important;
    transition: all 0.5s ease !important;
  }

  #jc-advisor-btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 20px 60px rgba(217, 119, 6, 0.3) !important;
  }

  /* JC Initials */
  .jc-initials {
    font-family: 'Caveat', cursive !important;
    font-size: 1.75rem !important;
    font-weight: 700 !important;
    color: #d97706 !important;
    line-height: 1 !important;
    display: inline-flex !important;
    align-items: baseline !important;
    transform: rotate(-10deg) !important;
    letter-spacing: -2px !important;
  }

  .j-letter {
    transform: translateY(-3px) !important;
    display: inline-block !important;
  }

  .c-letter {
    display: inline-block !important;
  }

  /* Mobile positioning */
  @media (max-width: 768px) {
    #jc-advisor-btn {
      bottom: 100px !important;
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL STYLES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  #progressivoAdvisorModal {
    position: fixed !important;
    inset: 0 !important;
    z-index: 10010 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 16px !important;
    background: rgba(15, 23, 42, 0.6) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  }

  #progressivoAdvisorModal.hidden {
    display: none !important;
  }

  #progressivoAdvisorModal > div {
    position: relative !important;
    width: 100% !important;
    max-width: 500px !important;
    background: rgba(15, 23, 42, 0.95) !important;
    backdrop-filter: blur(24px) !important;
    -webkit-backdrop-filter: blur(24px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 16px !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
    overflow: hidden !important;
  }

  #progressivoAdvisorModal h2 {
    font-family: var(--font-heading) !important;
    font-size: 1.5rem !important;
    color: #f8fafc !important;
    margin: 0 0 8px 0 !important;
    letter-spacing: 0.025em !important;
  }

  #progressivoAdvisorModal p {
    font-size: 0.875rem !important;
    color: #94a3b8 !important;
    margin: 0 !important;
  }

  #advisor-close-btn {
    position: absolute !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    background: transparent !important;
    border: none !important;
    color: #94a3b8 !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  #advisor-close-btn:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #f8fafc !important;
  }

  #progressivoAdvisorInput {
    width: 100% !important;
    min-height: 120px !important;
    padding: 16px !important;
    background: rgba(30, 41, 59, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    color: #f8fafc !important;
    font-family: var(--font-body) !important;
    font-size: 1rem !important;
    resize: none !important;
    transition: all 0.3s !important;
  }

  #progressivoAdvisorInput::placeholder {
    color: #64748b !important;
  }

  #progressivoAdvisorInput:focus {
    outline: none !important;
    border-color: rgba(217, 119, 6, 0.5) !important;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1) !important;
  }

  #advisor-ask-btn {
    width: 100% !important;
    padding: 12px 24px !important;
    background: #f8fafc !important;
    color: #0f172a !important;
    border: none !important;
    border-radius: 12px !important;
    font-weight: 700 !important;
    font-size: 0.875rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
  }

  #advisor-ask-btn:hover {
    background: #d97706 !important;
    color: #ffffff !important;
    box-shadow: 0 10px 30px rgba(217, 119, 6, 0.3) !important;
  }

  #progressivoAdvisorModal > div > div {
    padding: 24px !important;
  }
</style>

<!-- GLOBAL STYLES FOR DYNAMIC CHAT ELEMENTS -->
<style is:global>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAT HISTORY & AMBER LINKS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* Chat historie */
  #progressivoAdvisorHistory {
    margin-top: 20px !important;
    max-height: 400px !important;
    overflow-y: auto !important;
    padding: 16px !important;
    background: rgba(30, 41, 59, 0.3) !important;
    border-radius: 12px !important;
  }

  .chat-message {
    margin-bottom: 16px !important;
    padding: 12px !important;
    border-radius: 8px !important;
    line-height: 1.6 !important;
    font-size: 0.875rem !important;
  }

  .user-message {
    background: rgba(100, 116, 139, 0.2) !important;
    color: #cbd5e1 !important;
    text-align: right !important;
  }

  .ai-message {
    background: rgba(217, 119, 6, 0.1) !important;
    border: 1px solid rgba(217, 119, 6, 0.2) !important;
    color: #f8fafc !important;
  }

  /* ODKAZY - AMBER (DÅ®LEÅ½ITÃ‰!) */
  .ai-message a,
  #progressivoAdvisorHistory a {
    color: #d97706 !important;
    text-decoration: underline !important;
    font-weight: 600 !important;
    transition: color 0.3s !important;
  }

  .ai-message a:hover,
  #progressivoAdvisorHistory a:hover {
    color: #f59e0b !important;
  }

  /* Scrollbar pro historii */
  #progressivoAdvisorHistory::-webkit-scrollbar {
    width: 6px !important;
  }

  #progressivoAdvisorHistory::-webkit-scrollbar-track {
    background: rgba(30, 41, 59, 0.3) !important;
    border-radius: 3px !important;
  }

  #progressivoAdvisorHistory::-webkit-scrollbar-thumb {
    background: rgba(217, 119, 6, 0.5) !important;
    border-radius: 3px !important;
  }

  #progressivoAdvisorHistory::-webkit-scrollbar-thumb:hover {
    background: rgba(217, 119, 6, 0.7) !important;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex !important;
    gap: 8px !important;
    align-items: center !important;
  }

  .typing-indicator span {
    width: 8px !important;
    height: 8px !important;
    background: #d97706 !important;
    border-radius: 50% !important;
    animation: bounce 1.4s infinite ease-in-out both !important;
  }

  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s !important;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s !important;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: scale(0) !important;
    }
    40% {
      transform: scale(1) !important;
    }
  }
</style>

<script>
    // Magic Icon SVG constant (replaces Font Awesome)
    const magicIcon = `<svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor" style="display:inline-block; vertical-align:middle; margin-right:4px;"><path d="M224 96a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm122.5 23.3c-1.3-8.8-12.7-8.8-14 0L326 160l-40.7 6.5c-8.8 1.4-8.8 12.8 0 14.2L326 187l6.5 40.7c1.4 8.8 12.8 8.8 14.2 0l6.5-40.7 40.7-6.5c8.8-1.4 8.8-12.8 0-14.2L353.5 160l-6.5-40.7zM448 96a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM83.8 281.3C68.9 266.3 44.7 266.3 29.8 281.3s-14.9 39.1 0 54.1l208 208c14.9 14.9 39.1 14.9 54.1 0s14.9-39.1 0-54.1l-208-208zm26.9-26.9L379.3 85.8c6-6 15.5-6.6 22.2-1.5l26.2 19.6c6.4 4.8 6.9 14 1.2 19.5L163.5 379.6c-4.3 4.1-11.2 4.2-15.6 .2l-36.8-33.1c-4.4-4-4.5-10.9-.4-15.4z"/></svg>`;

    // Rate limiting
    let lastRequestTime = 0;
    const MIN_REQUEST_INTERVAL = 10000; // 10 sekund mezi requesty
    let isProcessing = false; // Prevence duplicitnÃ­ch requestÅ¯

    // UI texty podle jazyka
    const uiTexts = {
      cs: {
        title: 'Business Advisor',
        subtitle: 'PopiÅ¡te svou situaci a doporuÄÃ­m vÃ¡m Å™eÅ¡enÃ­.',
        placeholder: 'NapÅ™: Chci zaloÅ¾it firmu v PanamÄ›...',
        button: 'Poradit mi',
        error: 'Chyba. Kontaktujte nÃ¡s na info@progressivo.eu',
        emptyQuery: 'ProsÃ­m, napiÅ¡te svÅ¯j dotaz.',
        rateLimitMessage: 'ProsÃ­m poÄkejte {seconds} sekund mezi dotazy.'
      },
      en: {
        title: 'Business Advisor',
        subtitle: 'Describe your situation and I will recommend a solution.',
        placeholder: 'E.g: I want to start a company in Panama...',
        button: 'Advise me',
        error: 'Error. Contact us at info@progressivo.eu',
        emptyQuery: 'Please write your query.',
        rateLimitMessage: 'Please wait {seconds} seconds between queries.'
      },
      de: {
        title: 'Business Advisor',
        subtitle: 'Beschreiben Sie Ihre Situation und ich empfehle eine LÃ¶sung.',
        placeholder: 'Z.B: Ich mÃ¶chte eine Firma in Panama grÃ¼nden...',
        button: 'Beraten Sie mich',
        error: 'Fehler. Kontaktieren Sie uns unter info@progressivo.eu',
        emptyQuery: 'Bitte schreiben Sie Ihre Anfrage.',
        rateLimitMessage: 'Bitte warten Sie {seconds} Sekunden zwischen Anfragen.'
      },
      ru: {
        title: 'Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚',
        subtitle: 'ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ²Ğ°ÑˆÑƒ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ, Ğ¸ Ñ Ğ¿Ğ¾Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒÑ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ.',
        placeholder: 'ĞĞ°Ğ¿Ñ€: Ğ¥Ğ¾Ñ‡Ñƒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ² ĞŸĞ°Ğ½Ğ°Ğ¼Ğµ...',
        button: 'ĞŸĞ¾ÑĞ¾Ğ²ĞµÑ‚ÑƒĞ¹Ñ‚Ğµ Ğ¼Ğ½Ğµ',
        error: 'ĞÑˆĞ¸Ğ±ĞºĞ°. Ğ¡Ğ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ½Ğ°Ğ¼Ğ¸ info@progressivo.eu',
        emptyQuery: 'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ.',
        rateLimitMessage: 'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ {seconds} ÑĞµĞºÑƒĞ½Ğ´ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸.'
      },
      es: {
        title: 'Asesor Empresarial',
        subtitle: 'Describa su situaciÃ³n y le recomendarÃ© una soluciÃ³n.',
        placeholder: 'Ej: Quiero constituir una empresa en PanamÃ¡...',
        button: 'AconsÃ©jame',
        error: 'Error. ContÃ¡ctenos en info@progressivo.eu',
        emptyQuery: 'Por favor, escriba su consulta.',
        rateLimitMessage: 'Por favor espere {seconds} segundos entre consultas.'
      }
    };

    // Detekce aktuÃ¡lnÃ­ho jazyka
    function getCurrentLanguage() {
      const html = document.documentElement;
      const lang = html.getAttribute('lang') || 'cs';
      return lang.split('-')[0]; // cs, en, de, ru, es
    }

    // Aplikovat texty pÅ™i otevÅ™enÃ­
    function applyLanguageTexts() {
      const lang = getCurrentLanguage();
      const texts = uiTexts[lang] || uiTexts.cs;

      const title = document.getElementById('advisor-title');
      const subtitle = document.getElementById('advisor-subtitle');
      const input = document.getElementById('progressivoAdvisorInput');
      const button = document.getElementById('advisor-ask-btn');

      if (title) title.textContent = texts.title;
      if (subtitle) subtitle.textContent = texts.subtitle;
      if (input) input.placeholder = texts.placeholder;
      if (button) button.innerHTML = `${magicIcon} ${texts.button}`;
    }

    // Multi-language prompty
    function getPromptForLanguage(userQuery, lang) {
      const prompts = {
        cs: `Jsi business konzultant Jaroslava Cingela (Progressivo.eu).

SluÅ¾by (POUÅ½IJ PÅ˜ESNÃ‰ KOTVY):
1) #sluzby/analyza-dna - AnalÃ½za DNA
2) #sluzby/efektivni-integrace - EfektivnÃ­ integrace
3) #sluzby/it-podpora - IT podpora
4) #sluzby/online-kurzy - Online kurzy
5) #sluzby/expatriace - Expatriace a vÃ­za
6) #sluzby/nemovitosti - Nemovitosti
7) #sluzby/prekladatelska-cinnost - PÅ™ekladatelskÃ¡ Äinnost
8) #sluzby/online-prodej-techniky - Online prodej techniky

Dotaz: "${userQuery}"

Ãškol:
1. Analyzuj dotaz (1 vÄ›ta)
2. DoporuÄ KONKRÃ‰TNÃ sluÅ¾bu (2 vÄ›ty)
3. PouÅ¾ij PÅ˜ESNOU kotvu (napÅ™. #sluzby/expatriace)
4. NabÃ­dni kontakt (WhatsApp +507 68509698 nebo info@progressivo.eu)

Max 5 vÄ›t. OdpovÄ›z ÄŒESKY. DÅ®LEÅ½ITÃ‰: PouÅ¾Ã­vej POUZE kotvy ve formÃ¡tu #sluzby/nazev-sluzby`,

        en: `You are business consultant Jaroslav Cingel (Progressivo.eu).

Services (USE EXACT ANCHORS):
1) #sluzby/analyza-dna - DNA Analysis
2) #sluzby/efektivni-integrace - Efficient Integration
3) #sluzby/it-podpora - IT Support
4) #sluzby/online-kurzy - Online Courses
5) #sluzby/expatriace - Expatriation and Visas
6) #sluzby/nemovitosti - Real Estate
7) #sluzby/prekladatelska-cinnost - Translation Services
8) #sluzby/online-prodej-techniky - Online Tech Sales

Query: "${userQuery}"

Task:
1. Analyze query (1 sentence)
2. Recommend SPECIFIC service (2 sentences)
3. Use EXACT anchor (e.g. #sluzby/expatriace)
4. Offer contact (WhatsApp +507 68509698 or info@progressivo.eu)

Max 5 sentences. Answer in ENGLISH. IMPORTANT: Use ONLY anchors in format #sluzby/service-name`,

        de: `Du bist Unternehmensberater Jaroslav Cingel (Progressivo.eu).

Dienstleistungen (VERWENDE EXAKTE ANKER):
1) #sluzby/analyza-dna - DNA-Analyse
2) #sluzby/efektivni-integrace - Effiziente Integration
3) #sluzby/it-podpora - IT-Support
4) #sluzby/online-kurzy - Online-Kurse
5) #sluzby/expatriace - Expatriation und Visa
6) #sluzby/nemovitosti - Immobilien
7) #sluzby/prekladatelska-cinnost - Ãœbersetzungsdienste
8) #sluzby/online-prodej-techniky - Online-Technikverkauf

Anfrage: "${userQuery}"

Aufgabe: Analysiere (1 Satz), empfehle Service (2 SÃ¤tze), verwende EXAKTEN Anker (z.B. #sluzby/expatriace), biete Kontakt an. Max 5 SÃ¤tze. Antworte auf DEUTSCH.`,

        ru: `Ğ’Ñ‹ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚ Ğ¯Ñ€Ğ¾ÑĞ»Ğ°Ğ²Ğ° Ğ¦Ğ¸Ğ½Ğ³ĞµĞ»Ğ° (Progressivo.eu).

Ğ£ÑĞ»ÑƒĞ³Ğ¸ (Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ™Ğ¢Ğ• Ğ¢ĞĞ§ĞĞ«Ğ• Ğ¯ĞšĞĞ Ğ¯):
1) #sluzby/analyza-dna - ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ”ĞĞš
2) #sluzby/efektivni-integrace - Ğ­Ñ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ
3) #sluzby/it-podpora - IT-Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°
4) #sluzby/online-kurzy - ĞĞ½Ğ»Ğ°Ğ¹Ğ½-ĞºÑƒÑ€ÑÑ‹
5) #sluzby/expatriace - Ğ­ĞºÑĞ¿Ğ°Ñ‚Ñ€Ğ¸Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ²Ğ¸Ğ·Ñ‹
6) #sluzby/nemovitosti - ĞĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ
7) #sluzby/prekladatelska-cinnost - ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‡ĞµÑĞºĞ¸Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸
8) #sluzby/online-prodej-techniky - ĞĞ½Ğ»Ğ°Ğ¹Ğ½-Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸

Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ: "${userQuery}"

Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ (1 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ), Ğ¿Ğ¾Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞ¹Ñ‚Ğµ ÑƒÑĞ»ÑƒĞ³Ñƒ (2 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ), Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¢ĞĞ§ĞĞ«Ğ™ ÑĞºĞ¾Ñ€ÑŒ (Ğ½Ğ°Ğ¿Ñ€. #sluzby/expatriace), Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚. ĞœĞ°ĞºÑ 5 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹. ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ° Ğ Ğ£Ğ¡Ğ¡ĞšĞĞœ.`,

        es: `Eres consultor empresarial Jaroslav Cingel (Progressivo.eu).

Servicios (USA ANCLAS EXACTAS):
1) #sluzby/analyza-dna - AnÃ¡lisis de ADN
2) #sluzby/efektivni-integrace - IntegraciÃ³n Eficiente
3) #sluzby/it-podpora - Soporte IT
4) #sluzby/online-kurzy - Cursos Online
5) #sluzby/expatriace - ExpatriaciÃ³n y Visas
6) #sluzby/nemovitosti - Bienes RaÃ­ces
7) #sluzby/prekladatelska-cinnost - Servicios de TraducciÃ³n
8) #sluzby/online-prodej-techniky - Venta Online de TecnologÃ­a

Consulta: "${userQuery}"

Tarea: Analiza (1 frase), recomienda servicio (2 frases), usa ancla EXACTA (ej. #sluzby/expatriace), ofrece contacto. MÃ¡x 5 frases. Responde en ESPAÃ‘OL.`
      };

      return prompts[lang] || prompts.cs;
    }

    function initAdvisor() {
        const btn = document.getElementById('jc-advisor-btn');
        const modal = document.getElementById('progressivoAdvisorModal');
        const closeBtn = document.getElementById('advisor-close-btn');
        const askBtn = document.getElementById('advisor-ask-btn');
        const input = document.getElementById('progressivoAdvisorInput');
        const history = document.getElementById('progressivoAdvisorHistory');

        if (!btn || !modal) return;

        // --- SCROLL INTERACTION ---
        // Hide on scroll down, show on scroll up (matching Floating Dock logic)
        let lastScrollY = window.scrollY;
        let ticking = false;

        function updateAdvisorButton() {
            if (!btn) return;

            const currentScrollY = window.scrollY;

            if (currentScrollY > lastScrollY && currentScrollY > 100) {
                // Scrolling down - make it subtle
                btn.style.transform = 'scale(0.9)';
                btn.style.opacity = '0.6';
            } else {
                // Scrolling up or at top - full visibility
                btn.style.transform = 'scale(1)';
                btn.style.opacity = '1';
            }

            lastScrollY = currentScrollY;
            ticking = false;
        }

        const onScroll = () => {
            if (!ticking) {
                window.requestAnimationFrame(updateAdvisorButton);
                ticking = true;
            }
        };

        window.addEventListener('scroll', onScroll, { passive: true });
        updateAdvisorButton();

        // --- MODAL LOGIC ---
        let lastFocus;

        const openModal = () => {
            applyLanguageTexts();
            lastFocus = document.activeElement;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => input?.focus(), 100);
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            if (lastFocus) lastFocus.focus();
            if (input) input.value = '';
            // Clear history on close
            if (history) history.innerHTML = '';
        };

        btn.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);

        // CLICK OUTSIDE FIX
        const onModalClick = (event) => {
            if (event.target === modal) {
                closeModal();
            }
        };
        modal.addEventListener("click", onModalClick);


        // --- GEMINI LOGIC ---
        const askAdvisor = async () => {
            // Prevence duplicitnÃ­ch requestÅ¯
            if (isProcessing) {
              console.log('Request already in progress');
              return;
            }

            // Rate limit check
            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
              const timeLeft = Math.ceil((MIN_REQUEST_INTERVAL - (now - lastRequestTime)) / 1000);
              const lang = getCurrentLanguage();
              const texts = uiTexts[lang] || uiTexts.cs;
              alert(texts.rateLimitMessage.replace('{seconds}', timeLeft));
              return;
            }

            // Nastavit flagy
            isProcessing = true;
            lastRequestTime = now;

            const query = input.value.trim();
            if (!query) {
                isProcessing = false;
                const lang = getCurrentLanguage();
                const texts = uiTexts[lang] || uiTexts.cs;
                alert(texts.emptyQuery);
                return;
            }

            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai-message typing-indicator-container';
            typingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            history.appendChild(typingDiv);
            history.scrollTop = history.scrollHeight;

            const currentLang = getCurrentLanguage();
            const prompt = getPromptForLanguage(query, currentLang);

            try {
                const reply = await callAI(prompt);

                // Remove typing indicator
                typingDiv.remove();

                let fmt = reply.replace(/\n/g, '<br>');
                // New processing of links as requested
                fmt = fmt.replace(/#sluzby\/([a-z-]+)/gi,(match, serviceName)=>`<a href="#sluzby/${serviceName}" data-link-type="service" class="text-amber-600 hover:text-amber-700 underline font-semibold">#sluzby/${serviceName}</a>`);

                fmt = fmt.replace(/\+507 68509698/g, '<a href="https://wa.me/50768509698" target="_blank">+507 68509698 ğŸ“±</a>');
                // Email link to contact page
                fmt = fmt.replace(/info@progressivo\.eu/g, '<a href="/kontakt" data-link-type="internal" class="text-amber-600 underline font-semibold">info@progressivo.eu âœ‰ï¸</a>');

                // Append User Question (Secure Text Node)
                const questionDiv = document.createElement('div');
                questionDiv.className = 'chat-message user-message';
                questionDiv.innerHTML = '<strong>Vy:</strong> ';
                questionDiv.appendChild(document.createTextNode(query));

                // Append AI Answer
                const answerDiv = document.createElement('div');
                answerDiv.className = 'chat-message ai-message';
                answerDiv.innerHTML = `<strong>AI:</strong> ${fmt}`;

                history.appendChild(questionDiv);
                history.appendChild(answerDiv);

                // Scroll historie dolÅ¯
                history.scrollTop = history.scrollHeight;

                // VyÄistit textarea
                input.value = '';
                input.focus();

                // Re-attach listeners to new anchors

                // Odkazy na sluÅ¾by
                history.querySelectorAll('a[data-link-type="service"]').forEach(link => {
                  link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');

                    // ZavÅ™Ã­t modal
                    closeModal();

                    // PoÄkat a najÃ­t sluÅ¾bu
                    setTimeout(() => {
                      const serviceName = href.replace('#sluzby/', '');
                      const serviceCard = document.querySelector(`[data-service="${serviceName}"]`);

                      if (serviceCard) {
                        // Scrollnout na sekci sluÅ¾eb
                        const servicesSection = document.querySelector('#sluzby');
                        if (servicesSection) {
                          servicesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }

                        // PoÄkat na scroll, pak zvÃ½raznit + kliknout
                        setTimeout(() => {
                          serviceCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                          // ZvÃ½raznit
                          serviceCard.style.transform = 'scale(1.05)';
                          serviceCard.style.boxShadow = '0 0 30px rgba(217, 119, 6, 0.5)';

                          // Po 1s kliknout (otevÅ™e detail)
                          setTimeout(() => {
                            serviceCard.style.transform = '';
                            serviceCard.style.boxShadow = '';

                            const link = serviceCard.querySelector('a');
                            if (link) {
                                link.click();
                            } else {
                                // If the card is the link (which it is in index.astro)
                                serviceCard.click();
                            }
                          }, 1000);
                        }, 800);
                      }
                    }, 300);
                  });
                });

                // InternÃ­ odkazy (kontakt)
                history.querySelectorAll('a[data-link-type="internal"]').forEach(link => {
                  link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    closeModal();
                    setTimeout(() => {
                      window.location.href = href;
                    }, 300);
                  });
                });

                isProcessing = false;

            } catch (error) {
                isProcessing = false;
                console.error(error);
                typingDiv.remove();

                // Append Error
                const lang = getCurrentLanguage();
                const texts = uiTexts[lang] || uiTexts.cs;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message ai-message';
                errorDiv.style.borderColor = '#ef4444';
                errorDiv.innerHTML = `<div style="color: #ef4444;">${texts.error}</div>`;
                history.appendChild(errorDiv);
            }
        };

        askBtn?.addEventListener('click', askAdvisor);

        // Keydown (Escape)
        const onKeyDown = (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        };
        document.addEventListener('keydown', onKeyDown);

        // --- CLEANUP ---
        const cleanup = () => {
            window.removeEventListener('scroll', onScroll);
            document.removeEventListener('keydown', onKeyDown);
            btn.removeEventListener('click', openModal);
            closeBtn?.removeEventListener('click', closeModal);
            modal.removeEventListener('click', onModalClick);
            askBtn?.removeEventListener('click', askAdvisor);
        };

        document.addEventListener('astro:before-swap', cleanup, { once: true });
    }

    // Call Cloudflare Function
    async function callAI(prompt) {
      try {
        const response = await fetch('/api/ask-ai', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `API Error: ${response.status}`);
        }

        const data = await response.json();
        return data.response;
      } catch (error) {
        console.error('AI call error:', error);
        throw error;
      }
    }

    document.addEventListener('astro:page-load', initAdvisor);
</script>
