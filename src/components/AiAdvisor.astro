---
---

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">

<!-- AI ADVISOR BUTTON -->
<button id="jc-advisor-btn">
  <span class="jc-initials">
    <span class="j-letter">J</span><span class="c-letter">C</span>
  </span>
</button>

<!-- AI ADVISOR MODAL -->
<div id="progressivoAdvisorModal" class="hidden">
    <div>
        <button id="advisor-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div>
            <h2>Business Advisor</h2>
            <p>Popi≈°te svou situaci a doporuƒç√≠m v√°m ≈ôe≈°en√≠.</p>

            <textarea id="progressivoAdvisorInput" placeholder="Nap≈ô: Chci zalo≈æit firmu v Panamƒõ..."></textarea>

            <button id="advisor-ask-btn">
                <i class="fas fa-magic"></i> Poradit mi
            </button>

            <div id="progressivoAdvisorResult" class="hidden"></div>
        </div>
    </div>
</div>

<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BUTTON STYLES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  #jc-advisor-btn {
    position: fixed !important;
    bottom: 24px !important;
    right: 24px !important;
    z-index: 10000 !important;

    width: 56px !important;
    height: 56px !important;
    border-radius: 9999px !important;

    display: flex !important;
    align-items: center !important;
    justify-content: center !important;

    background: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;

    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;

    cursor: pointer !important;
    transition: all 0.5s ease !important;
  }

  #jc-advisor-btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 20px 60px rgba(217, 119, 6, 0.3) !important;
  }

  /* JC Initials */
  .jc-initials {
    font-family: 'Caveat', cursive !important;
    font-size: 1.75rem !important;
    font-weight: 700 !important;
    color: #d97706 !important;
    line-height: 1 !important;
    display: inline-flex !important;
    align-items: baseline !important;
    transform: rotate(-10deg) !important;
    letter-spacing: -2px !important;
  }

  .j-letter {
    transform: translateY(-3px) !important;
    display: inline-block !important;
  }

  .c-letter {
    display: inline-block !important;
  }

  /* Mobile positioning */
  @media (max-width: 768px) {
    #jc-advisor-btn {
      bottom: 120px !important;
    }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL STYLES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  #progressivoAdvisorModal {
    position: fixed !important;
    inset: 0 !important;
    z-index: 10010 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 16px !important;
    background: rgba(15, 23, 42, 0.6) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  }

  #progressivoAdvisorModal.hidden {
    display: none !important;
  }

  #progressivoAdvisorModal > div {
    position: relative !important;
    width: 100% !important;
    max-width: 500px !important;
    background: rgba(15, 23, 42, 0.95) !important;
    backdrop-filter: blur(24px) !important;
    -webkit-backdrop-filter: blur(24px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 16px !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
    overflow: hidden !important;
  }

  #progressivoAdvisorModal h2 {
    font-family: var(--font-heading) !important;
    font-size: 1.5rem !important;
    color: #f8fafc !important;
    margin: 0 0 8px 0 !important;
    letter-spacing: 0.025em !important;
  }

  #progressivoAdvisorModal p {
    font-size: 0.875rem !important;
    color: #94a3b8 !important;
    margin: 0 !important;
  }

  #advisor-close-btn {
    position: absolute !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    background: transparent !important;
    border: none !important;
    color: #94a3b8 !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  #advisor-close-btn:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #f8fafc !important;
  }

  #progressivoAdvisorInput {
    width: 100% !important;
    min-height: 120px !important;
    padding: 16px !important;
    background: rgba(30, 41, 59, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    color: #f8fafc !important;
    font-family: var(--font-body) !important;
    font-size: 1rem !important;
    resize: none !important;
    transition: all 0.3s !important;
  }

  #progressivoAdvisorInput::placeholder {
    color: #64748b !important;
  }

  #progressivoAdvisorInput:focus {
    outline: none !important;
    border-color: rgba(217, 119, 6, 0.5) !important;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1) !important;
  }

  #advisor-ask-btn {
    width: 100% !important;
    padding: 12px 24px !important;
    background: #f8fafc !important;
    color: #0f172a !important;
    border: none !important;
    border-radius: 12px !important;
    font-weight: 700 !important;
    font-size: 0.875rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
  }

  #advisor-ask-btn:hover {
    background: #d97706 !important;
    color: #ffffff !important;
    box-shadow: 0 10px 30px rgba(217, 119, 6, 0.3) !important;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     RESULT AREA + ODKAZY (AMBER)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  #progressivoAdvisorResult {
    margin-top: 24px !important;
    padding: 20px !important;
    background: rgba(217, 119, 6, 0.1) !important;
    border: 1px solid rgba(217, 119, 6, 0.2) !important;
    border-radius: 12px !important;
    color: #f8fafc !important;
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
  }

  #progressivoAdvisorResult.hidden {
    display: none !important;
  }

  /* ODKAZY - AMBER BARVA */
  #progressivoAdvisorResult a {
    color: #d97706 !important;
    text-decoration: underline !important;
    font-weight: 600 !important;
    transition: color 0.3s !important;
  }

  #progressivoAdvisorResult a:hover {
    color: #f59e0b !important;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex !important;
    gap: 8px !important;
    align-items: center !important;
  }

  .typing-indicator span {
    width: 8px !important;
    height: 8px !important;
    background: #d97706 !important;
    border-radius: 50% !important;
    animation: bounce 1.4s infinite ease-in-out both !important;
  }

  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s !important;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s !important;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: scale(0) !important;
    }
    40% {
      transform: scale(1) !important;
    }
  }

  #progressivoAdvisorModal > div > div {
    padding: 24px !important;
  }
</style>

<script>
    function initAdvisor() {
        const btn = document.getElementById('jc-advisor-btn');
        const modal = document.getElementById('progressivoAdvisorModal');
        const closeBtn = document.getElementById('advisor-close-btn');
        const askBtn = document.getElementById('advisor-ask-btn');
        const input = document.getElementById('progressivoAdvisorInput');
        const result = document.getElementById('progressivoAdvisorResult');

        if (!btn || !modal) return;

        // --- SCROLL INTERACTION ---
        // Hide on scroll down, show on scroll up (matching Floating Dock logic)
        let lastScrollY = window.scrollY;
        let ticking = false;

        function updateAdvisorButton() {
            if (!btn) return;

            const currentScrollY = window.scrollY;

            if (currentScrollY > lastScrollY && currentScrollY > 100) {
                // Scrolling down - make it subtle
                btn.style.transform = 'scale(0.9)';
                btn.style.opacity = '0.6';
            } else {
                // Scrolling up or at top - full visibility
                btn.style.transform = 'scale(1)';
                btn.style.opacity = '1';
            }

            lastScrollY = currentScrollY;
            ticking = false;
        }

        const onScroll = () => {
            if (!ticking) {
                window.requestAnimationFrame(updateAdvisorButton);
                ticking = true;
            }
        };

        window.addEventListener('scroll', onScroll, { passive: true });
        updateAdvisorButton();

        // --- MODAL LOGIC ---
        let lastFocus;

        const openModal = () => {
            lastFocus = document.activeElement;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => input?.focus(), 100);
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            if (lastFocus) lastFocus.focus();
            if (input) input.value = '';
            if (result) result.classList.add('hidden');
        };

        btn.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);

        // CLICK OUTSIDE FIX
        const onModalClick = (event) => {
            if (event.target === modal) {
                closeModal();
            }
        };
        modal.addEventListener("click", onModalClick);


        // --- GEMINI LOGIC ---
        const askAdvisor = async () => {
            const query = input.value.trim();
            if (!query) { alert('Pros√≠m, napi≈°te sv≈Øj dotaz.'); return; }

            result.classList.remove('hidden');
            result.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            const prompt = `Jsi business konzultant Jaroslava Cingela (Progressivo.eu). Slu≈æby: 1) Zakl√°d√°n√≠ firem v Panamƒõ 2) Da≈àov√© poradenstv√≠ 3) IT podpora 4) Pr√°vn√≠ slu≈æby 5) Expat asistence. Dotaz: "${query}". √ökol: Analyzuj (1 vƒõta), doporuƒç slu≈æbu (2 vƒõty), navrhni sekci webu (#sluzby), nab√≠dni kontakt (WhatsApp +507 68509698 nebo info@progressivo.eu). Max 5 vƒõt. ƒåe≈°tina.`;

            try {
                const reply = await callGemini(prompt);
                let fmt = reply.replace(/\n/g, '<br>');
                fmt = fmt.replace(/#([a-z-]+)/gi, (m,s) => `<a href="#${s}" data-link-type="anchor">#${s}</a>`);
                fmt = fmt.replace(/\+507 68509698/g, '<a href="https://wa.me/50768509698" target="_blank">+507 68509698 üì±</a>');
                fmt = fmt.replace(/info@progressivo\.eu/g, '<a href="mailto:info@progressivo.eu">info@progressivo.eu ‚úâÔ∏è</a>');
                result.innerHTML = `<div>${fmt}</div>`;

                // Re-attach listeners to new anchors
                result.querySelectorAll('a[data-link-type="anchor"]').forEach(a => {
                    a.addEventListener('click', closeModal);
                });
            } catch (error) {
                console.error(error);
                result.innerHTML = '<div style="color: #ef4444;">Chyba. Kontaktujte n√°s na info@progressivo.eu</div>';
            }
        };

        askBtn?.addEventListener('click', askAdvisor);

        // Keydown (Escape)
        const onKeyDown = (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        };
        document.addEventListener('keydown', onKeyDown);

        // --- CLEANUP ---
        const cleanup = () => {
            window.removeEventListener('scroll', onScroll);
            document.removeEventListener('keydown', onKeyDown);
            btn.removeEventListener('click', openModal);
            closeBtn?.removeEventListener('click', closeModal);
            modal.removeEventListener('click', onModalClick);
            askBtn?.removeEventListener('click', askAdvisor);
        };

        document.addEventListener('astro:before-swap', cleanup, { once: true });
    }

    async function callGemini(prompt) {
        const key = atob("QUl6YVN5QU9qNXJ3MXNNWDgwM3AxTG5zaWc3YjBCMDIzTVFnZWhR");
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${key}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        const data = await res.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI se zamyslela. Zkuste znovu.";
    }

    document.addEventListener('astro:page-load', initAdvisor);
</script>
