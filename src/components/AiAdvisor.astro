---
---

<!-- AI ADVISOR BUTTON -->
<button id="jc-advisor-btn">
  <span class="jc-initials">
    <span class="j-letter">J</span><span class="c-letter">C</span>
  </span>
</button>

<!-- AI ADVISOR MODAL -->
<div id="progressivoAdvisorModal" class="hidden">
    <div>
        <button id="advisor-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div>
            <h2 id="advisor-title">Business Advisor</h2>
            <p id="advisor-subtitle">Popi≈°te svou situaci a doporuƒç√≠m v√°m ≈ôe≈°en√≠.</p>

            <div id="progressivoAdvisorHistory" style="margin-top: 20px; max-height: 400px; overflow-y: auto;"></div>

            <textarea id="progressivoAdvisorInput" placeholder="Nap≈ô: Chci zalo≈æit firmu v Panamƒõ..."></textarea>

            <button id="advisor-ask-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg> Poradit mi
            </button>
        </div>
    </div>
</div>

<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BUTTON STYLES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  #jc-advisor-btn {
    position: fixed !important;
    bottom: 24px !important;
    right: 24px !important;
    z-index: 10000 !important;

    width: 56px !important;
    height: 56px !important;
    border-radius: 9999px !important;

    display: flex !important;
    align-items: center !important;
    justify-content: center !important;

    background: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;

    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;

    cursor: pointer !important;
    transition: all 0.5s ease !important;
  }

  #jc-advisor-btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 20px 60px rgba(217, 119, 6, 0.3) !important;
  }

  /* JC Initials */
  .jc-initials {
    font-family: 'Caveat', cursive !important;
    font-size: 1.75rem !important;
    font-weight: 700 !important;
    color: #d97706 !important;
    line-height: 1 !important;
    display: inline-flex !important;
    align-items: baseline !important;
    transform: rotate(-10deg) !important;
    letter-spacing: -2px !important;
  }

  .j-letter {
    transform: translateY(-3px) !important;
    display: inline-block !important;
  }

  .c-letter {
    display: inline-block !important;
  }

  /* Mobile positioning */
  @media (max-width: 768px) {
    #jc-advisor-btn {
      bottom: 100px !important;
    }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL STYLES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  #progressivoAdvisorModal {
    position: fixed !important;
    inset: 0 !important;
    z-index: 10010 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 16px !important;
    background: rgba(15, 23, 42, 0.6) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  }

  #progressivoAdvisorModal.hidden {
    display: none !important;
  }

  #progressivoAdvisorModal > div {
    position: relative !important;
    width: 100% !important;
    max-width: 500px !important;
    background: rgba(15, 23, 42, 0.95) !important;
    backdrop-filter: blur(24px) !important;
    -webkit-backdrop-filter: blur(24px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 16px !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
    overflow: hidden !important;
  }

  #progressivoAdvisorModal h2 {
    font-family: var(--font-heading) !important;
    font-size: 1.5rem !important;
    color: #f8fafc !important;
    margin: 0 0 8px 0 !important;
    letter-spacing: 0.025em !important;
  }

  #progressivoAdvisorModal p {
    font-size: 0.875rem !important;
    color: #94a3b8 !important;
    margin: 0 !important;
  }

  #advisor-close-btn {
    position: absolute !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    background: transparent !important;
    border: none !important;
    color: #94a3b8 !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  #advisor-close-btn:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #f8fafc !important;
  }

  #progressivoAdvisorInput {
    width: 100% !important;
    min-height: 120px !important;
    padding: 16px !important;
    background: rgba(30, 41, 59, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    color: #f8fafc !important;
    font-family: var(--font-body) !important;
    font-size: 1rem !important;
    resize: none !important;
    transition: all 0.3s !important;
  }

  #progressivoAdvisorInput::placeholder {
    color: #64748b !important;
  }

  #progressivoAdvisorInput:focus {
    outline: none !important;
    border-color: rgba(217, 119, 6, 0.5) !important;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1) !important;
  }

  #advisor-ask-btn {
    width: 100% !important;
    padding: 12px 24px !important;
    background: #f8fafc !important;
    color: #0f172a !important;
    border: none !important;
    border-radius: 12px !important;
    font-weight: 700 !important;
    font-size: 0.875rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
  }

  #advisor-ask-btn:hover {
    background: #d97706 !important;
    color: #ffffff !important;
    box-shadow: 0 10px 30px rgba(217, 119, 6, 0.3) !important;
  }

  #progressivoAdvisorModal > div > div {
    padding: 24px !important;
  }
</style>

<!-- GLOBAL STYLES FOR DYNAMIC CHAT ELEMENTS -->
<style is:global>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAT HISTORY & AMBER LINKS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  /* Chat historie */
  #progressivoAdvisorHistory {
    margin-top: 20px !important;
    max-height: 400px !important;
    overflow-y: auto !important;
    padding: 16px !important;
    background: rgba(30, 41, 59, 0.3) !important;
    border-radius: 12px !important;
  }

  .chat-message {
    margin-bottom: 16px !important;
    padding: 12px !important;
    border-radius: 8px !important;
    line-height: 1.6 !important;
    font-size: 0.875rem !important;
  }

  .user-message {
    background: rgba(100, 116, 139, 0.2) !important;
    color: #cbd5e1 !important;
    text-align: right !important;
  }

  .ai-message {
    background: rgba(217, 119, 6, 0.1) !important;
    border: 1px solid rgba(217, 119, 6, 0.2) !important;
    color: #f8fafc !important;
  }

  /* ODKAZY - AMBER (D≈ÆLE≈ΩIT√â!) */
  .ai-message a,
  #progressivoAdvisorHistory a {
    color: #d97706 !important;
    text-decoration: underline !important;
    font-weight: 600 !important;
    transition: color 0.3s !important;
  }

  .ai-message a:hover,
  #progressivoAdvisorHistory a:hover {
    color: #f59e0b !important;
  }

  /* Scrollbar pro historii */
  #progressivoAdvisorHistory::-webkit-scrollbar {
    width: 6px !important;
  }

  #progressivoAdvisorHistory::-webkit-scrollbar-track {
    background: rgba(30, 41, 59, 0.3) !important;
    border-radius: 3px !important;
  }

  #progressivoAdvisorHistory::-webkit-scrollbar-thumb {
    background: rgba(217, 119, 6, 0.5) !important;
    border-radius: 3px !important;
  }

  #progressivoAdvisorHistory::-webkit-scrollbar-thumb:hover {
    background: rgba(217, 119, 6, 0.7) !important;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex !important;
    gap: 8px !important;
    align-items: center !important;
  }

  .typing-indicator span {
    width: 8px !important;
    height: 8px !important;
    background: #d97706 !important;
    border-radius: 50% !important;
    animation: bounce 1.4s infinite ease-in-out both !important;
  }

  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s !important;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s !important;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: scale(0) !important;
    }
    40% {
      transform: scale(1) !important;
    }
  }
</style>

<script>
    // Rate limiting
    let lastRequestTime = 0;
    const MIN_REQUEST_INTERVAL = 10000; // 10 sekund mezi requesty
    let isProcessing = false; // Prevence duplicitn√≠ch request≈Ø

    // UI texty podle jazyka
    const uiTexts = {
      cs: {
        title: 'Business Advisor',
        subtitle: 'Popi≈°te svou situaci a doporuƒç√≠m v√°m ≈ôe≈°en√≠.',
        placeholder: 'Nap≈ô: Chci zalo≈æit firmu v Panamƒõ...',
        button: 'Poradit mi',
        error: 'Chyba. Kontaktujte n√°s na info@progressivo.eu',
        emptyQuery: 'Pros√≠m, napi≈°te sv≈Øj dotaz.',
        rateLimitMessage: 'Pros√≠m poƒçkejte {seconds} sekund mezi dotazy.'
      },
      en: {
        title: 'Business Advisor',
        subtitle: 'Describe your situation and I will recommend a solution.',
        placeholder: 'E.g: I want to start a company in Panama...',
        button: 'Advise me',
        error: 'Error. Contact us at info@progressivo.eu',
        emptyQuery: 'Please write your query.',
        rateLimitMessage: 'Please wait {seconds} seconds between queries.'
      },
      de: {
        title: 'Business Advisor',
        subtitle: 'Beschreiben Sie Ihre Situation und ich empfehle eine L√∂sung.',
        placeholder: 'Z.B: Ich m√∂chte eine Firma in Panama gr√ºnden...',
        button: 'Beraten Sie mich',
        error: 'Fehler. Kontaktieren Sie uns unter info@progressivo.eu',
        emptyQuery: 'Bitte schreiben Sie Ihre Anfrage.',
        rateLimitMessage: 'Bitte warten Sie {seconds} Sekunden zwischen Anfragen.'
      },
      ru: {
        title: '–ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç',
        subtitle: '–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é, –∏ —è –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Ä–µ—à–µ–Ω–∏–µ.',
        placeholder: '–ù–∞–ø—Ä: –•–æ—á—É –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –≤ –ü–∞–Ω–∞–º–µ...',
        button: '–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –º–Ω–µ',
        error: '–û—à–∏–±–∫–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ info@progressivo.eu',
        emptyQuery: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å.',
        rateLimitMessage: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ {seconds} —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.'
      },
      es: {
        title: 'Asesor Empresarial',
        subtitle: 'Describa su situaci√≥n y le recomendar√© una soluci√≥n.',
        placeholder: 'Ej: Quiero constituir una empresa en Panam√°...',
        button: 'Acons√©jame',
        error: 'Error. Cont√°ctenos en info@progressivo.eu',
        emptyQuery: 'Por favor, escriba su consulta.',
        rateLimitMessage: 'Por favor espere {seconds} segundos entre consultas.'
      }
    };

    // Detekce aktu√°ln√≠ho jazyka
    function getCurrentLanguage() {
      const html = document.documentElement;
      const lang = html.getAttribute('lang') || 'cs';
      return lang.split('-')[0]; // cs, en, de, ru, es
    }

    // Aplikovat texty p≈ôi otev≈ôen√≠
    function applyLanguageTexts() {
      const lang = getCurrentLanguage();
      const texts = uiTexts[lang] || uiTexts.cs;

      const title = document.getElementById('advisor-title');
      const subtitle = document.getElementById('advisor-subtitle');
      const input = document.getElementById('progressivoAdvisorInput');
      const button = document.getElementById('advisor-ask-btn');

      if (title) title.textContent = texts.title;
      if (subtitle) subtitle.textContent = texts.subtitle;
      if (input) input.placeholder = texts.placeholder;
      if (button) button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg> ${texts.button}`;
    }

    // Multi-language prompty
    function getPromptForLanguage(userQuery, lang) {
      const prompts = {
        cs: `Jsi business konzultant Jaroslava Cingela (Progressivo.eu).

Slu≈æby (POU≈ΩIJ P≈òESN√â KOTVY):
1) #sluzby/analyza-dna - Anal√Ωza DNA
2) #sluzby/efektivni-integrace - Efektivn√≠ integrace
3) #sluzby/it-podpora - IT podpora
4) #sluzby/online-kurzy - Online kurzy
5) #sluzby/expatriace - Expatriace a v√≠za
6) #sluzby/nemovitosti - Nemovitosti
7) #sluzby/prekladatelska-cinnost - P≈ôekladatelsk√° ƒçinnost
8) #sluzby/online-prodej-techniky - Online prodej techniky

Dotaz: "${userQuery}"

√ökol:
1. Analyzuj dotaz (1 vƒõta)
2. Doporuƒç KONKR√âTN√ç slu≈æbu (2 vƒõty)
3. Pou≈æij P≈òESNOU kotvu (nap≈ô. #sluzby/expatriace)
4. Nab√≠dni kontakt (WhatsApp +507 68509698 nebo info@progressivo.eu)

Max 5 vƒõt. Odpovƒõz ƒåESKY. D≈ÆLE≈ΩIT√â: Pou≈æ√≠vej POUZE kotvy ve form√°tu #sluzby/nazev-sluzby`,

        en: `You are business consultant Jaroslav Cingel (Progressivo.eu).

Services (USE EXACT ANCHORS):
1) #sluzby/analyza-dna - DNA Analysis
2) #sluzby/efektivni-integrace - Efficient Integration
3) #sluzby/it-podpora - IT Support
4) #sluzby/online-kurzy - Online Courses
5) #sluzby/expatriace - Expatriation and Visas
6) #sluzby/nemovitosti - Real Estate
7) #sluzby/prekladatelska-cinnost - Translation Services
8) #sluzby/online-prodej-techniky - Online Tech Sales

Query: "${userQuery}"

Task:
1. Analyze query (1 sentence)
2. Recommend SPECIFIC service (2 sentences)
3. Use EXACT anchor (e.g. #sluzby/expatriace)
4. Offer contact (WhatsApp +507 68509698 or info@progressivo.eu)

Max 5 sentences. Answer in ENGLISH. IMPORTANT: Use ONLY anchors in format #sluzby/service-name`,

        de: `Du bist Unternehmensberater Jaroslav Cingel (Progressivo.eu).

Dienstleistungen (VERWENDE EXAKTE ANKER):
1) #sluzby/analyza-dna - DNA-Analyse
2) #sluzby/efektivni-integrace - Effiziente Integration
3) #sluzby/it-podpora - IT-Support
4) #sluzby/online-kurzy - Online-Kurse
5) #sluzby/expatriace - Expatriation und Visa
6) #sluzby/nemovitosti - Immobilien
7) #sluzby/prekladatelska-cinnost - √úbersetzungsdienste
8) #sluzby/online-prodej-techniky - Online-Technikverkauf

Anfrage: "${userQuery}"

Aufgabe: Analysiere (1 Satz), empfehle Service (2 S√§tze), verwende EXAKTEN Anker (z.B. #sluzby/expatriace), biete Kontakt an. Max 5 S√§tze. Antworte auf DEUTSCH.`,

        ru: `–í—ã –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –Ø—Ä–æ—Å–ª–∞–≤–∞ –¶–∏–Ω–≥–µ–ª–∞ (Progressivo.eu).

–£—Å–ª—É–≥–∏ (–ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –¢–û–ß–ù–´–ï –Ø–ö–û–†–Ø):
1) #sluzby/analyza-dna - –ê–Ω–∞–ª–∏–∑ –î–ù–ö
2) #sluzby/efektivni-integrace - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
3) #sluzby/it-podpora - IT-–ø–æ–¥–¥–µ—Ä–∂–∫–∞
4) #sluzby/online-kurzy - –û–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã
5) #sluzby/expatriace - –≠–∫—Å–ø–∞—Ç—Ä–∏–∞—Ü–∏—è –∏ –≤–∏–∑—ã
6) #sluzby/nemovitosti - –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
7) #sluzby/prekladatelska-cinnost - –ü–µ—Ä–µ–≤–æ–¥—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏
8) #sluzby/online-prodej-techniky - –û–Ω–ª–∞–π–Ω-–ø—Ä–æ–¥–∞–∂–∞ —Ç–µ—Ö–Ω–∏–∫–∏

–ó–∞–ø—Ä–æ—Å: "${userQuery}"

–ó–∞–¥–∞—á–∞: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ), –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π—Ç–µ —É—Å–ª—É–≥—É (2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–ß–ù–´–ô —è–∫–æ—Ä—å (–Ω–∞–ø—Ä. #sluzby/expatriace), –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç. –ú–∞–∫—Å 5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –†–£–°–°–ö–û–ú.`,

        es: `Eres consultor empresarial Jaroslav Cingel (Progressivo.eu).

Servicios (USA ANCLAS EXACTAS):
1) #sluzby/analyza-dna - An√°lisis de ADN
2) #sluzby/efektivni-integrace - Integraci√≥n Eficiente
3) #sluzby/it-podpora - Soporte IT
4) #sluzby/online-kurzy - Cursos Online
5) #sluzby/expatriace - Expatriaci√≥n y Visas
6) #sluzby/nemovitosti - Bienes Ra√≠ces
7) #sluzby/prekladatelska-cinnost - Servicios de Traducci√≥n
8) #sluzby/online-prodej-techniky - Venta Online de Tecnolog√≠a

Consulta: "${userQuery}"

Tarea: Analiza (1 frase), recomienda servicio (2 frases), usa ancla EXACTA (ej. #sluzby/expatriace), ofrece contacto. M√°x 5 frases. Responde en ESPA√ëOL.`
      };

      return prompts[lang] || prompts.cs;
    }

    function initAdvisor() {
        const btn = document.getElementById('jc-advisor-btn');
        const modal = document.getElementById('progressivoAdvisorModal');
        const closeBtn = document.getElementById('advisor-close-btn');
        const askBtn = document.getElementById('advisor-ask-btn');
        const input = document.getElementById('progressivoAdvisorInput');
        const history = document.getElementById('progressivoAdvisorHistory');

        if (!btn || !modal) return;

        // --- SCROLL INTERACTION ---
        // Hide on scroll down, show on scroll up (matching Floating Dock logic)
        let lastScrollY = window.scrollY;
        let ticking = false;

        function updateAdvisorButton() {
            if (!btn) return;

            const currentScrollY = window.scrollY;

            if (currentScrollY > lastScrollY && currentScrollY > 100) {
                // Scrolling down - make it subtle
                btn.style.transform = 'scale(0.9)';
                btn.style.opacity = '0.6';
            } else {
                // Scrolling up or at top - full visibility
                btn.style.transform = 'scale(1)';
                btn.style.opacity = '1';
            }

            lastScrollY = currentScrollY;
            ticking = false;
        }

        const onScroll = () => {
            if (!ticking) {
                window.requestAnimationFrame(updateAdvisorButton);
                ticking = true;
            }
        };

        window.addEventListener('scroll', onScroll, { passive: true });
        updateAdvisorButton();

        // --- MODAL LOGIC ---
        let lastFocus;

        const openModal = () => {
            applyLanguageTexts();
            lastFocus = document.activeElement;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => input?.focus(), 100);
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            if (lastFocus) lastFocus.focus();
            if (input) input.value = '';
            // Clear history on close
            if (history) history.innerHTML = '';
        };

        btn.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);

        // CLICK OUTSIDE FIX
        const onModalClick = (event) => {
            if (event.target === modal) {
                closeModal();
            }
        };
        modal.addEventListener("click", onModalClick);


        // --- GEMINI LOGIC ---
        const askAdvisor = async () => {
            // Prevence duplicitn√≠ch request≈Ø
            if (isProcessing) {
              console.log('Request already in progress');
              return;
            }

            // Rate limit check
            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
              const timeLeft = Math.ceil((MIN_REQUEST_INTERVAL - (now - lastRequestTime)) / 1000);
              const lang = getCurrentLanguage();
              const texts = uiTexts[lang] || uiTexts.cs;
              alert(texts.rateLimitMessage.replace('{seconds}', timeLeft));
              return;
            }

            // Nastavit flagy
            isProcessing = true;
            lastRequestTime = now;

            const query = input.value.trim();
            if (!query) {
                isProcessing = false;
                const lang = getCurrentLanguage();
                const texts = uiTexts[lang] || uiTexts.cs;
                alert(texts.emptyQuery);
                return;
            }

            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai-message typing-indicator-container';
            typingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            history.appendChild(typingDiv);
            history.scrollTop = history.scrollHeight;

            const currentLang = getCurrentLanguage();
            const prompt = getPromptForLanguage(query, currentLang);

            try {
                const reply = await callAI(prompt);

                // Remove typing indicator
                typingDiv.remove();

                let fmt = reply.replace(/\n/g, '<br>');
                // New processing of links as requested
                fmt = fmt.replace(/#sluzby\/([a-z-]+)/gi,(match, serviceName)=>`<a href="#sluzby/${serviceName}" data-link-type="service" class="text-amber-600 hover:text-amber-700 underline font-semibold">#sluzby/${serviceName}</a>`);

                fmt = fmt.replace(/\+507 68509698/g, '<a href="https://wa.me/50768509698" target="_blank">+507 68509698 üì±</a>');
                // Email link to contact page
                fmt = fmt.replace(/info@progressivo\.eu/g, '<a href="/kontakt" data-link-type="internal" class="text-amber-600 underline font-semibold">info@progressivo.eu ‚úâÔ∏è</a>');

                // Append User Question (Secure Text Node)
                const questionDiv = document.createElement('div');
                questionDiv.className = 'chat-message user-message';
                questionDiv.innerHTML = '<strong>Vy:</strong> ';
                questionDiv.appendChild(document.createTextNode(query));

                // Append AI Answer
                const answerDiv = document.createElement('div');
                answerDiv.className = 'chat-message ai-message';
                answerDiv.innerHTML = `<strong>AI:</strong> ${fmt}`;

                history.appendChild(questionDiv);
                history.appendChild(answerDiv);

                // Scroll historie dol≈Ø
                history.scrollTop = history.scrollHeight;

                // Vyƒçistit textarea
                input.value = '';
                input.focus();

                // Re-attach listeners to new anchors

                // Odkazy na slu≈æby
                history.querySelectorAll('a[data-link-type="service"]').forEach(link => {
                  link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');

                    // Zav≈ô√≠t modal
                    closeModal();

                    // Poƒçkat a naj√≠t slu≈æbu
                    setTimeout(() => {
                      const serviceName = href.replace('#sluzby/', '');
                      const serviceCard = document.querySelector(`[data-service="${serviceName}"]`);

                      if (serviceCard) {
                        // Scrollnout na sekci slu≈æeb
                        const servicesSection = document.querySelector('#sluzby');
                        if (servicesSection) {
                          servicesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }

                        // Poƒçkat na scroll, pak zv√Ωraznit + kliknout
                        setTimeout(() => {
                          serviceCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                          // Zv√Ωraznit
                          serviceCard.style.transform = 'scale(1.05)';
                          serviceCard.style.boxShadow = '0 0 30px rgba(217, 119, 6, 0.5)';

                          // Po 1s kliknout (otev≈ôe detail)
                          setTimeout(() => {
                            serviceCard.style.transform = '';
                            serviceCard.style.boxShadow = '';

                            const link = serviceCard.querySelector('a');
                            if (link) {
                                link.click();
                            } else {
                                // If the card is the link (which it is in index.astro)
                                serviceCard.click();
                            }
                          }, 1000);
                        }, 800);
                      }
                    }, 300);
                  });
                });

                // Intern√≠ odkazy (kontakt)
                history.querySelectorAll('a[data-link-type="internal"]').forEach(link => {
                  link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    closeModal();
                    setTimeout(() => {
                      window.location.href = href;
                    }, 300);
                  });
                });

                isProcessing = false;

            } catch (error) {
                isProcessing = false;
                console.error(error);
                typingDiv.remove();

                // Append Error
                const lang = getCurrentLanguage();
                const texts = uiTexts[lang] || uiTexts.cs;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message ai-message';
                errorDiv.style.borderColor = '#ef4444';
                errorDiv.innerHTML = `<div style="color: #ef4444;">${texts.error}</div>`;
                history.appendChild(errorDiv);
            }
        };

        askBtn?.addEventListener('click', askAdvisor);

        // Keydown (Escape)
        const onKeyDown = (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        };
        document.addEventListener('keydown', onKeyDown);

        // --- CLEANUP ---
        const cleanup = () => {
            window.removeEventListener('scroll', onScroll);
            document.removeEventListener('keydown', onKeyDown);
            btn.removeEventListener('click', openModal);
            closeBtn?.removeEventListener('click', closeModal);
            modal.removeEventListener('click', onModalClick);
            askBtn?.removeEventListener('click', askAdvisor);
        };

        document.addEventListener('astro:before-swap', cleanup, { once: true });
    }

    // Call Cloudflare Function
    async function callAI(prompt) {
      try {
        const response = await fetch('/api/ask-ai', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `API Error: ${response.status}`);
        }

        const data = await response.json();
        return data.response;
      } catch (error) {
        console.error('AI call error:', error);
        throw error;
      }
    }

    document.addEventListener('astro:page-load', initAdvisor);
</script>
