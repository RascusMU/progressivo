---
import { useTranslations } from '../i18n/utils';
import { defaultLang } from '../i18n/ui';

const { lang = defaultLang } = Astro.props;
const t = useTranslations(lang);

// Get the translation object for the accordion
// In Astro frontmatter, we can cast or treat as any if type safety is an issue,
// but since we are in JS/loose TS mode here, it should work.
const translations = t('itutoring_accordion') as any;

// Helper type for sections if we were in TS mode, but in Astro frontmatter JS is loose
const sections = [
  {
    id: 'co-nabizime',
    title: translations.offer_title,
    description: translations.offer_desc,
    points: [
      translations.offer_p1,
      translations.offer_p2,
      translations.offer_p3,
      translations.offer_p4,
      translations.offer_p5,
      translations.offer_p6
    ],
    cta: { text: translations.offer_cta, url: 'https://marketplace.itutoring.cz/doucovani' }
  },
  {
    id: 'jak-to-funguje',
    title: translations.how_title,
    description: translations.how_desc,
    points: [
      translations.how_p1,
      translations.how_p2,
      translations.how_p3,
      translations.how_p4
    ],
    cta: null
  },
  {
    id: 'pro-koho-je-to',
    title: translations.target_title,
    description: translations.target_desc,
    points: [
      translations.target_p1,
      translations.target_p2,
      translations.target_p3,
      translations.target_p4,
      translations.target_p5
    ],
    cta: null
  },
  {
    id: 'proc-itutoring',
    title: translations.why_title,
    description: translations.why_desc,
    points: [
      translations.why_p1,
      translations.why_p2,
      translations.why_p3,
      translations.why_p4,
      translations.why_p5,
      translations.why_p6,
      translations.why_p7
    ],
    cta: { text: translations.why_cta, url: 'https://itutoring.cz/reference' }
  },
  {
    id: 'ceny-a-platba',
    title: translations.pricing_title,
    description: translations.pricing_desc,
    points: [
      translations.pricing_p1,
      translations.pricing_p2,
      translations.pricing_p3,
      translations.pricing_p4,
      translations.pricing_p5
    ],
    cta: { text: translations.pricing_cta, url: 'https://itutoring.cz/cenik' }
  },
  {
    id: 'mobilni-aplikace',
    title: translations.app_title,
    description: translations.app_desc,
    points: [
      translations.app_p1,
      translations.app_p2,
      translations.app_p3,
      translations.app_p4,
      translations.app_p5,
      translations.app_p6
    ],
    cta: { text: translations.app_cta, url: 'https://portal.itutoring.cz' }
  },
  {
    id: 'kontakt',
    title: translations.contact_title,
    description: translations.contact_desc,
    points: [
      translations.contact_p1,
      translations.contact_p2,
      translations.contact_p3,
      translations.contact_p4
    ],
    cta: { text: translations.contact_cta, url: 'https://itutoring.cz/#kontakt' }
  }
];
---

<div class="itutoring-accordion">
  <header class="accordion-header-main">
    <div class="header-icon">ðŸŽ“</div>
    <div class="header-text">
      <h3>iTutoring.cz</h3>
      <span class="badge">{translations.badge}</span>
    </div>
  </header>

  <div class="accordion-container">
    {sections.map((section, index) => (
      <div class="accordion-item" data-id={section.id}>
        <button class="accordion-trigger" aria-expanded="false" aria-controls={`content-${section.id}`}>
          <span class="trigger-content">
            <span class="trigger-title">{section.title}</span>
            <span class="trigger-desc">{section.description}</span>
          </span>
          <span class="trigger-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </button>
        <div id={`content-${section.id}`} class="accordion-content" hidden>
          <div class="content-inner">
            <ul class="points-list">
              {section.points.map(point => (
                <li>{point}</li>
              ))}
            </ul>
            {section.cta && (
              <a href={section.cta.url} target="_blank" rel="noopener noreferrer" class="cta-link">
                {section.cta.text} <span>â†’</span>
              </a>
            )}
          </div>
        </div>
      </div>
    ))}
  </div>
</div>

<style>
  .itutoring-accordion {
    width: 100%;
    max-width: 800px;
    margin: 2rem auto;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  :global(.dark) .itutoring-accordion {
    background: rgba(30, 41, 59, 0.5);
  }

  .accordion-header-main {
    padding: 1.5rem;
    background: rgba(217, 119, 6, 0.1); /* Amber tint */
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header-icon {
    font-size: 2rem;
  }

  .header-text h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text);
  }

  .badge {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-accent); /* Amber */
    font-weight: 600;
  }

  .accordion-item {
    border-bottom: 1px solid var(--color-border);
  }

  .accordion-item:last-child {
    border-bottom: none;
  }

  .accordion-trigger {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;
    transition: background-color 0.2s ease;
  }

  .accordion-trigger:hover {
    background: rgba(0, 0, 0, 0.02);
  }

  :global(.dark) .accordion-trigger:hover {
    background: rgba(255, 255, 255, 0.02);
  }

  .trigger-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .trigger-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--color-text);
  }

  .trigger-desc {
    font-size: 0.9rem;
    color: var(--color-text-light);
    opacity: 0.8;
  }

  .trigger-icon {
    color: var(--color-accent);
    transition: transform 0.3s ease;
    flex-shrink: 0;
    margin-left: 1rem;
  }

  .accordion-trigger[aria-expanded="true"] .trigger-icon {
    transform: rotate(180deg);
  }

  .accordion-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s ease-out;
  }

  /* When open, we animate to 1fr via JS or CSS class helper */
  .accordion-content.is-open {
    grid-template-rows: 1fr;
  }

  .content-inner {
    overflow: hidden;
    padding: 0 1.5rem 1.5rem 1.5rem;
  }

  .points-list {
    margin: 1rem 0;
    padding-left: 1.5rem;
    list-style-type: disc;
    color: var(--color-text);
  }

  .points-list li {
    margin-bottom: 0.5rem;
  }

  .cta-link {
    display: inline-block;
    margin-top: 0.5rem;
    color: var(--color-accent);
    font-weight: 600;
    text-decoration: none;
    transition: transform 0.2s;
  }

  .cta-link:hover {
    text-decoration: underline;
    transform: translateX(4px);
  }

  .cta-link span {
    display: inline-block;
    transition: transform 0.2s;
  }

  .cta-link:hover span {
    transform: translateX(2px);
  }

  @media (max-width: 640px) {
    .trigger-content {
        max-width: 80%;
    }
  }
</style>

<script>
  function initAccordion() {
    const accordions = document.querySelectorAll('.itutoring-accordion');

    accordions.forEach(accordion => {
      if (accordion.hasAttribute('data-initialized')) return;
      accordion.setAttribute('data-initialized', 'true');

      const triggers = accordion.querySelectorAll('.accordion-trigger');

      triggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
          const contentId = trigger.getAttribute('aria-controls');
          const content = document.getElementById(contentId);

          // Close all other items in this accordion
          triggers.forEach(otherTrigger => {
            if (otherTrigger !== trigger) {
              otherTrigger.setAttribute('aria-expanded', 'false');
              const otherContentId = otherTrigger.getAttribute('aria-controls');
              const otherContent = document.getElementById(otherContentId);
              if (otherContent) {
                otherContent.classList.remove('is-open');
                otherContent.hidden = true;
              }
            }
          });

          // Toggle current item
          if (isExpanded) {
            trigger.setAttribute('aria-expanded', 'false');
            content.classList.remove('is-open');

            setTimeout(() => {
                if(trigger.getAttribute('aria-expanded') === 'false') {
                    content.hidden = true;
                }
            }, 300);
          } else {
            content.hidden = false;
            // Force reflow
            content.offsetHeight;
            trigger.setAttribute('aria-expanded', 'true');
            content.classList.add('is-open');
          }
        });
      });
    });
  }

  // Run on View Transitions navigation (and initial load if ClientRouter is present)
  document.addEventListener('astro:page-load', initAccordion);

  // Also run immediately just in case astro:page-load missed (fallback)
  // but strictly checking data-initialized handles duplication.
  initAccordion();
</script>
